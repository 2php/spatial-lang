2. F1 Instances
===============

Summary of Steps
----------------

Unlike simulation, running on the F1 requires a few simple manual steps in the initial Spatial release. 
These depend on your personal AWS account (EC2 and S3). Specifically, 
following synthesis Amazon requires the bitstream to be uploaded to your S3 account, and an EC2
account is needed to launch an F1 instance to run the spatial application in hardware.

This tutorial describes the following steps:

- Authenticating your AWS account
- Generating and synthesizing a Spatial design. In our experience, synthesis/place/route takes 4-12 hours depending on design size
- Uploading the bitstream (AKA design checkpoint, or DCP) to Amazon S3 and waiting approximately 2 hours for the Amazon FPGA Image (AFI) associated with this bitstream to become valid
- Opening an F1 instance through your EC2 account and running the spatial application
- Running the spatial application


Step 1: Authenticating your AWS account
---------------------------------------

Follow `these steps <http://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html#id_root-user_manage_add-key>`_ to create a file ``rootkey.csv``. This file can be placed anywhere, and will be needed for later steps to run commands associated with your AWS account.


Step 2: Generate and Synthesize your application
------------------------------------------------

.. highlight:: bash

The first step is the same as compiling a Spatial application for any other target, shown here for the ``MatMult_outer`` example::

    cd ${SPATIAL_HOME}
    bin/spatial MatMult_outer --chisel

You can replace ``MatMult_outer`` with any application, as described in :doc:`the previous tutorial<../tutorial/helloworld>`.

Now generate the F1 design and run synthesis/place/route to begin creating the Amazon FPGA Image (AFI)::

    cd ${SPATIAL_HOME}/gen/MatMult_outer
    make aws-F1-afi

Notice that once this command completes, Vivado synthesis will be running in the background. A text file called ``create_spatial_AFI_instructions.txt`` has also been created. Follow the instructions in this text file (also described below) once Vivado completes to upload the Design Checkpoint (DCP) and finish creating the AFI.

Vivado will have completed once the ``*.vivado.log`` file has printed ``Finished creating final tar file in to_aws directory.``. You can also check if the ``vivado`` process has stopped.


Step 3: Creating the AFI
------------------------

See the generated file ``create_spatial_AFI_instructions.txt``, which guides the user step-by-step on how to upload the DCP to S3 and then run the ``create-fpga-image`` command.

Once ``create-fpga-image`` has been run, wait for the ``logs`` directory in S3 to be filled, and ensure that the AFI state in the file called ``State`` is available.


Step 4: Opening an F1 instance
------------------------------

Start an F1 instance in the AWS console. We tested with Amazon's `FPGA Developer AMI <https://aws.amazon.com/marketplace/pp/B06VVYBLZZ#>`_ although this might not be necessary.

If you already have an existing F1 instance (e.g. for a previous Spatial application), skip to the next step. If this is your first time starting the F1 instance, follow the one-time setup steps below.

Clone Amazon's `EC2 FPGA Hardware and Software Development Kit <https://github.com/aws/aws-fpga/>`_ to any location, e.g. ``/home/centos/src/project_data``::

    git clone https://github.com/aws/aws-fpga.git

Put the following (replacing with your chosen path above) in your ``.bashrc``::

    cd /home/centos/src/project_data/aws-fpga/
    source /home/centos/src/project_data/aws-fpga/hdk_setup.sh
    source /home/centos/src/project_data/aws-fpga/sdk_setup.sh

Source the ``.bashrc``::

    source ~/.bashrc

Then follow `these instructions <https://github.com/aws/aws-fpga/blob/master/sdk/linux_kernel_drivers/edma/edma_install.md#howToCompile>`_ to build and install the required EDMA driver. Summary::

    cd sdk/linux_kernel_drivers/edma/
    echo 'edma' | sudo tee --append /etc/modules-load.d/edma.conf
    sudo cp edma-drv.ko /lib/modules/`uname -r`/
    sudo depmod
    sudo modprobe edma-drv

Step 5: Running the Spatial application
---------------------------------------

Generate the software using::

    make aws-F1-afi

We recommend doing this on the F1 instance, although you can do it anywhere and copy over the binary (this might require changing permissions to run it). To do it on the F1 instance, you only need the ``software/runtime`` and ``software/include`` directories of the generated Spatial AWS application.

Run the application using the commands below in the ``runtime`` directory. Eventually this will be automated::

    sudo fpga-clear-local-image -S 0
    sleep 25
    sudo fpga-load-local-image -S 0 -I agfi-INSERT_ID_HERE
    # make clean
    # make all
    sleep 10
    sudo fpga-describe-local-image -S 0 -R -H
    sudo rmmod edma-drv && sudo insmod /home/centos/src/project_data/aws-fpga/sdk/linux_kernel_drivers/edma/edma-drv.ko
    sudo ./Top arg1 arg2 ...

Explanation of the above commands:

- Currently we require a board reset prior to running an application. Eventually this will not be needed
- In addition, eventually the ``agfi`` above will be written to a file which the Spatial application reads. For now it is part of the commands.
